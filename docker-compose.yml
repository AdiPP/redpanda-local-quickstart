name: redpanda-quickstart-one-broker
networks:
    redpanda_network:
        driver: bridge
volumes:
    redpanda-0: null

services:
    redpanda-0:
        command:
            - redpanda
            - start
            - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
            - --advertise-kafka-addr internal://redpanda-0:9092,external://localhost:19092
            - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
            - --advertise-pandaproxy-addr internal://redpanda-0:8082,external://localhost:18082
            - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
            - --rpc-addr redpanda-0:33145
            - --advertise-rpc-addr redpanda-0:33145
            - --mode dev-container
            - --smp 1
            - --default-log-level=info
            # SASL configuration
            - --set redpanda.enable_sasl=true
            - --set redpanda.superusers=["admin"]
            - --set redpanda.sasl_mechanisms=["SCRAM","PLAIN"]
        image: docker.redpanda.com/redpandadata/redpanda:v25.3.7
        container_name: redpanda-0
        volumes:
            - redpanda-0:/var/lib/redpanda/data
        networks:
            - redpanda_network
        ports:
            - 18081:18081
            - 18082:18082
            - 19092:19092
            - 19644:9644

    # --- AUTO-SETUP CONTAINER ---
    redpanda-setup:
        image: docker.redpanda.com/redpandadata/redpanda:v25.3.7
        container_name: redpanda-setup
        networks:
            - redpanda_network
        depends_on:
            - redpanda-0
        restart: "no"
        entrypoint: /bin/sh
        # This script loops until Redpanda is ready, creates the user, then exits.
        command: >
            -c "
            echo 'Waiting for Redpanda to be ready...';
            until rpk security user create admin --password password --mechanism SCRAM-SHA-256 --api-urls http://redpanda-0:9644; do
              echo 'Broker not ready yet, retrying in 3 seconds...';
              sleep 3;
            done;
            echo 'User created successfully! Shutting down setup container.';
            "

    console:
        container_name: redpanda-console
        image: docker.redpanda.com/redpandadata/console:v3.5.2
        networks:
            - redpanda_network
        entrypoint: /bin/sh
        command: -c 'echo "$$CONSOLE_CONFIG_FILE" > /tmp/config.yml; /app/console'
        environment:
            CONFIG_FILEPATH: /tmp/config.yml
            CONSOLE_CONFIG_FILE: |
                kafka:
                  brokers: ["redpanda-0:9092"]
                  sasl:
                    enabled: true
                    mechanism: SCRAM-SHA-256
                    username: admin
                    password: password
                schemaRegistry:
                  enabled: true
                  urls: ["http://redpanda-0:8081"]
                redpanda:
                  adminApi:
                    enabled: true
                    urls: ["http://redpanda-0:9644"]
        ports:
            - 8080:8080
        depends_on:
            # Console waits for the setup container to finish its job before starting
            redpanda-setup:
                condition: service_completed_successfully